# ТЗ: Telegram Mini App «Трекер привычек»

Версия: 1.0  
Дата: 2026-02-13  
Формат: мини‑приложение (Telegram Mini App / Web App) во встроенном WebView, запуск из Telegram‑бота в полноэкранном режиме.

---

## 1) Цель и ожидаемый результат

**Цель** — дать пользователю простой ежедневный инструмент для отметки привычек и просмотра прогресса за неделю.

**Ключевой UX**:
- Пользователь видит список привычек.
- За 1–2 нажатия отмечает выполненные привычки.
- Видит линейный график: «сколько привычек выполнено по дням недели».
- Понимает, что делать дальше (пустые состояния, подсказки, ошибки).

---

## 2) Область работ и ограничения

### 2.1 Входит в MVP
- Главный экран: список привычек + чекбоксы + недельный график.
- CRUD привычек: создать / переименовать / удалить / архивировать.
- Навигация по неделям: текущая неделя + просмотр прошлых.
- Хранение данных на пользователя (персистентность).
- Устойчивость к ошибкам ввода и сетевым сбоям (сообщения, ретраи).
- Интеграция и запуск из Telegram‑бота.
- Деплой фронтенда (и бэкенда, если выбран) + документация запуска.

### 2.2 Не входит в MVP (можно заложить «крючки»)
- Социальные функции (шаринг, лидерборды).
- Платежи/подписки.
- Напоминания через пуши (в Telegram это реализуется через сообщения ботом).
- Сложные расписания привычек (по дням недели, «X раз в неделю») — можно оставить как расширение.

---

## 3) Термины и определения

- **Привычка (Habit)** — элемент списка, который пользователь отмечает как выполненный.
- **Отметка выполнения (Completion)** — факт выполнения привычки в конкретную дату.
- **Неделя** — интервал из 7 дней. По умолчанию считается «неделя по ISO» (понедельник–воскресенье).
- **Выбранный день** — день внутри недели, к которому относятся текущие чекбоксы (по умолчанию — сегодня).

---

## 4) Пользовательские сценарии (user stories)

1. **Первый запуск**:  
   Пользователь открывает мини‑приложение → видит пустое состояние → добавляет первую привычку → отмечает выполнение.

2. **Ежедневное использование**:  
   Пользователь открывает → день «сегодня» выделен → отмечает 1–N привычек → график обновляется.

3. **Просмотр прогресса**:  
   Пользователь переключает неделю назад → видит график и отметки → может переключить выбранный день и посмотреть, что было сделано.

4. **Управление привычками**:  
   Пользователь открывает «Управление привычками» → добавляет/редактирует/архивирует/удаляет.

---

## 5) UI/UX: экраны и элементы интерфейса

### 5.1 Общие принципы интерфейса
- Одноэкранный флоу, минимальная когнитивная нагрузка.
- Мобильный приоритет (Telegram iOS/Android), с адаптацией под Desktop.
- Учет темы Telegram (light/dark) и динамических изменений темы.
- Ясные состояния: загрузка, пусто, ошибка, офлайн.

### 5.2 Экран 1: «Трекер привычек» (главный)

#### 5.2.1 Верхняя панель (Header)
- Заголовок по центру: **«Трекер привычек»**.
- Справа: иконка «☰» (меню/настройки).
- Поведение:
  - Нажатие на «☰» открывает **Bottom Sheet / Drawer** с пунктами меню (см. 5.4).

#### 5.2.2 Левая колонка: список привычек
> На узких экранах (телефон) список может стать выезжающей панелью (drawer) либо занимать верхнюю часть экрана, чтобы не ломать компоновку.

Элемент списка (карточка привычки):
- Текст: название привычки.
- Справа внутри карточки: чекбокс (toggle).
- Дополнительно (опционально в MVP, но желательно):
  - Мини‑иконка/цветовой маркер привычки (для визуального различения).
  - Состояние «архив» скрывает привычку из основного списка.

Состояния карточки:
- **Обычное**: чекбокс пуст/отмечен.
- **Disabled**: если выбранная дата недоступна для редактирования (см. правила по датам).
- **Ошибка синхронизации**: маленькая иконка рядом с чекбоксом + tooltip/подсказка «Сохранение не завершено, повторить».

Взаимодействия:
- Тап по чекбоксу → переключение выполнения привычки для **выбранного дня**.
- Long‑press / контекстное меню (опционально):
  - «Переименовать»
  - «Архивировать»
  - «Удалить»

Пустое состояние списка:
- Текст: «Пока нет привычек»
- Кнопка: «Добавить привычку»
- Подсказка: «Создайте 1–3 привычки, которые хотите выполнять ежедневно»

#### 5.2.3 Центральная область: линейный график
Один линейный график с 7 точками (дни недели), отображает:
- X‑ось: дни недели (Пн–Вс) с датами.
- Y‑ось: целое число (0..N), где N = количество активных привычек.
- Линия соединяет точки по порядку дней.

Интерактив:
- Тап по точке/дню → меняется **выбранный день**.
- Tooltip по точке: «ДД.ММ — выполнено X из N».
- Текущий выбранный день визуально выделен (точка + подпись).

Состояния:
- **Загрузка**: skeleton/placeholder.
- **Нет данных**: график с нулевой линией и подсказкой «Добавьте привычки и отметьте выполнение».
- **Ошибка загрузки**: placeholder + кнопка «Повторить».

#### 5.2.4 Нижняя полоса: дни недели (навигация по дням)
- 7 элементов в ряд (точка + дата, как на скетче).
- Нажатие по дню:
  - выбирает день,
  - обновляет состояние чекбоксов в списке привычек.

Правила выбора:
- По умолчанию выбирается «сегодня» в текущей неделе.
- При переключении недели выбирается понедельник этой недели, либо день, совпадающий с сегодняшним weekday (решение: **выбирать понедельник** для предсказуемости).

---

### 5.3 Экран 2: «Управление привычками»
Открывается из меню (☰).

Элементы:
- Список привычек с возможностью:
  - Добавить (кнопка «+ Добавить привычку»)
  - Переименовать
  - Поменять порядок (drag&drop)
  - Архивировать / разархивировать
  - Удалить (с подтверждением)

Поля привычки:
- Название (обязательное).
- Цвет/иконка (опционально, если успеваем в MVP).

Валидации:
- Название 1–40 символов (конфигурируемо).
- Запрещены пустые строки и строки из пробелов.
- Запрещены дубли (сравнение case‑insensitive + trim).

---

### 5.4 Меню (☰) — Bottom Sheet / Drawer
Пункты:
1. **Управление привычками**
2. **Неделя: предыдущая**
3. **Неделя: следующая** (disabled, если следующая выходит за текущую дату)
4. **Сброс отметок за выбранный день** (опасное действие, с подтверждением)
5. **Справка** (коротко: как пользоваться)
6. **О приложении** (версия)

---

## 6) Функциональные требования (FR)

### FR‑1. Инициализация Telegram Mini App
- Приложение получает контекст пользователя через `Telegram.WebApp.initData` и `initDataUnsafe`.
- Приложение вызывает `Telegram.WebApp.ready()` после первичной инициализации UI.
- Приложение разворачивается на максимальную доступную высоту через `Telegram.WebApp.expand()`.

### FR‑2. Модель данных
**Habit**
- `id: string` (uuid/ulid)
- `title: string`
- `order: number`
- `status: "active" | "archived"`
- `createdAt: string (ISO)`
- `updatedAt: string (ISO)`
- (опционально) `color: string`

**Completion**
- Храним как словарь по датам:  
  `completionsByDate: { "YYYY-MM-DD": string[] /* habitIds выполненные в этот день */ }`

Правила:
- Один habitId в массиве даты встречается максимум один раз.
- При удалении привычки completion можно чистить лениво (на чтении фильтровать по существующим habitId).

### FR‑3. Работа с датами и неделями
- Дата внутри приложения приводится к `YYYY-MM-DD` в локальной таймзоне устройства.
- Неделя считается по ISO (Пн–Вс).
- Пользователь может просматривать любые прошлые недели.
- Редактирование отметок разрешено:
  - для текущей недели: для любых дней внутри недели,
  - для прошлых недель: разрешено по умолчанию (вариант A) **или** запрещено (вариант B).  
  Выбор для MVP: **вариант A (разрешено)**, так проще и предсказуемее.

### FR‑4. Чекбокс выполнения
- Переключение чекбокса меняет выполнение привычки для выбранной даты.
- После изменения:
  - обновляется локальный state,
  - пересчитывается количество выполненных привычек по дням недели,
  - обновляется график,
  - запускается сохранение (см. FR‑6).

### FR‑5. CRUD привычек
- Добавление привычки:
  - через кнопку в пустом состоянии и через экран управления.
  - после добавления привычка появляется в списке на главном экране.
- Переименование:
  - сохраняет порядок,
  - обновляет `updatedAt`.
- Архивация:
  - скрывает привычку из основного списка,
  - архив можно посмотреть/вернуть из «Управление привычками».
- Удаление:
  - подтверждение (диалог),
  - после удаления привычка исчезает,
  - completion очищается лениво либо сразу (зависит от выбранной реализации, критично обеспечить корректный график).

### FR‑6. Персистентность (хранение данных)
Базовый вариант хранения для MVP: **Telegram CloudStorage**.
- Ключи:
  - `habits_v1`
  - `completions_v1`
  - `schema_version`
- Формат: JSON‑строка.
- На старте:
  - читаем CloudStorage,
  - валидируем схему,
  - при ошибке показываем понятное сообщение и кнопку «Повторить».

Fallback:
- Если CloudStorage недоступен или вернул ошибку:
  - сохраняем в `localStorage`,
  - показываем баннер «Синхронизация недоступна, данные сохранены на устройстве» + «Повторить синхронизацию».

### FR‑7. Миграции схемы
- В данных хранится `schema_version`.
- При изменении структуры данных добавляется миграция `v1 -> v2`, и т. д.
- При невозможности миграции:
  - приложение запускается в режиме «только чтение»,
  - показывает инструкцию пользователю «Обновите приложение/перезапустите».

### FR‑8. Обработка ошибок пользователя
Ошибки ввода:
- Пустое название → подсветка поля + текст «Введите название».
- Слишком длинное название → «Сократите до 40 символов».
- Дубликат → «Такая привычка уже есть».

Ошибки действий:
- Попытка удалить последнюю привычку: разрешено, но показывается пустое состояние.
- Сброс отметок: всегда через подтверждение.

### FR‑9. Понятные подсказки пользователю
- Подсказка по первому использованию (один раз): «Нажимайте на чекбоксы, чтобы отмечать выполнение».
- Tooltip/баннер при проблемах синхронизации.
- Экран «Справка» с 5–7 короткими пунктами.

### FR‑10. Инструменты Telegram UI (опционально, но рекомендовано)
- Использовать `Telegram.WebApp.MainButton` как контекстную кнопку:
  - На главном экране: «Добавить привычку».
  - В управлении привычками: «Готово».
- Обрабатывать `backButtonClicked` для навигации назад внутри мини‑приложения.

---

## 7) Нефункциональные требования (NFR)

### NFR‑1. Производительность
- Время до интерактивности на средних устройствах: до 1.5 сек при холодном старте.
- Число привычек в MVP: целевой комфортный лимит 50 активных (при превышении — предупреждение).
- График рисуется быстро, без тяжелых зависимостей. Предпочтение: SVG‑рендер.

### NFR‑2. Надежность
- Любая операция сохранения должна иметь:
  - таймаут,
  - повтор (retry) с экспоненциальной задержкой,
  - понятную ошибку для пользователя.
- Приложение не должно «ломаться» от частых переключений дней/недель.

### NFR‑3. Совместимость
- Telegram iOS, Android, Desktop (WebView).
- Поддержка основных размеров экранов и safe‑area (вырезы/индикаторы).

### NFR‑4. Доступность
- Минимально:
  - достаточный контраст,
  - кликабельные зоны 44px+,
  - управление с клавиатуры на Desktop (tab/enter),
  - ARIA‑лейблы для чекбоксов.

### NFR‑5. Безопасность и приватность
- Сохраняемые данные: только привычки и отметки выполнения.
- Если используется бэкенд (опционально): проверка `initData` на сервере по алгоритму Telegram и ограничение по `auth_date` (lifetime).
- В клиенте: хранить `initData` только в памяти, без записи в storage.

### NFR‑6. Наблюдаемость
- Логирование ошибок (Sentry или аналог).
- События (опционально): `habit_created`, `habit_toggled`, `week_changed`, `storage_error`.

---

## 8) Техническая архитектура (рекомендованная)

### 8.1 Фронтенд
- TypeScript + React (Vite).
- UI: легкий компонентный подход (например, shadcn/ui или собственные компоненты).
- Состояние: Zustand/Redux Toolkit (на выбор).
- График: SVG‑компонент (собственный) либо легкая библиотека.

### 8.2 Хранилище
- Основное: `Telegram.WebApp.CloudStorage`.
- Резерв: `localStorage` + флаг «не синхронизировано».
- Валидация данных: Zod (или аналог) на чтении/записи.

### 8.3 Навигация
- 2 маршрута:
  - `/` — главный экран
  - `/manage` — управление привычками
- Router: react-router.

---

## 9) Интеграция с Telegram: запуск и настройки

### 9.1 Способ запуска
Поддержать два способа:
1. **Кнопка в сообщении бота** (InlineKeyboardButton с `web_app`).
2. **Кнопка меню в чате** (Menu Button), чтобы приложение открывалось из интерфейса чата.

### 9.2 Настройка через BotFather
- Создать бота через BotFather (`/newbot`) и получить токен.
- Настроить кнопку меню:
  - команда BotFather: `/setmenubutton`
  - выбрать бота
  - указать URL мини‑приложения (HTTPS)
  - задать подпись кнопки (например, «Открыть трекер»)

> Команда `/setmenubutton` описана в документации Telegram Mini Apps community‑docs. citeturn0search2

### 9.3 Сообщение с кнопкой запуска (бот)
Бот по команде `/start` должен отправлять сообщение с кнопкой:
- Текст: «Откройте трекер привычек»
- Inline keyboard: кнопка `web_app` → URL мини‑приложения.

Рекомендация: дополнительно поддержать deep‑link формата `t.me/<bot>?startapp=<payload>` для сценариев, где нужен параметр запуска.

### 9.4 Требования к URL и хостингу
- Только HTTPS.
- Один домен, стабильный URL (без частых изменений).
- Корректные заголовки:
  - `Content-Type`
  - `Cache-Control` для статики
  - CSP (минимально) с учетом загрузки скриптов приложения.

### 9.5 Использование Telegram WebApp API в приложении
- На старте:
  - `Telegram.WebApp.ready()`
  - `Telegram.WebApp.expand()`
- Обработка событий:
  - `themeChanged` → обновление темы.
  - `viewportChanged` / safe‑area → корректная высота и отступы.
- Считывание пользователя:
  - `Telegram.WebApp.initDataUnsafe.user` (id, username, language_code).
- Если бэкенд используется:
  - передавать `Telegram.WebApp.initData` на сервер,
  - сервер валидирует по алгоритму Telegram.

> Алгоритм валидации initData описан в официальной документации Telegram Web Apps. citeturn1view0

---

## 10) Деплой: порядок действий

### 10.1 Репозиторий
Ожидаемая структура:
- `apps/web/` — фронтенд
- `apps/bot/` — Telegram bot (опционально, если в одном репо)
- `README.md` — инструкции запуска и деплоя
- `.env.example`

### 10.2 Локальный запуск (developer)
- `pnpm install`
- `pnpm dev`
- Поднять HTTPS локально:
  - вариант: ngrok / cloudflared tunnel
  - получить публичный HTTPS URL и временно использовать в кнопке бота.

### 10.3 Production деплой (frontend)
Рекомендуемые варианты:
- Vercel / Netlify / Cloudflare Pages / GitHub Pages (при условии HTTPS и корректной работы в WebView).
- CI:
  - lint + typecheck + build
  - деплой по merge в main

### 10.4 Деплой бота
Варианты:
- Render / Fly.io / Railway / VPS.
- Бот хранит токен в secret env var.
- Бот отправляет web_app кнопку с URL на фронтенд.

### 10.5 Post‑deploy checklist
- URL открывается в Telegram iOS и Android.
- Тема переключается корректно.
- CloudStorage работает (создание привычки → перезапуск → данные на месте).
- Ошибка CloudStorage имитируется (отключить сеть) → виден fallback и понятное сообщение.

---

## 11) Обработка ошибок: требования к сообщениям

Общие правила:
- Сообщения короткие, без технических терминов.
- Любая ошибка предлагает действие: «Повторить», «Открыть управление», «Проверить сеть».

Набор сообщений (минимум):
1. «Не удалось загрузить данные. Проверьте интернет и попробуйте снова.»
2. «Синхронизация временно недоступна. Данные сохранены на устройстве.»
3. «Введите название привычки.»
4. «Такая привычка уже есть.»
5. «Не удалось сохранить изменения. Нажмите “Повторить”.»

---

## 12) Приемка (Definition of Done)

Функциональная приемка:
- Пользователь может:
  - добавить привычку,
  - отметить выполнение на выбранный день,
  - увидеть обновление графика,
  - переключать дни недели и недели,
  - управлять привычками (CRUD).
- Данные сохраняются между запусками.

Качество:
- Приложение устойчиво к:
  - пустому вводу,
  - повторным кликам,
  - отсутствию сети,
  - ошибкам CloudStorage.
- UI адаптивен и корректен в light/dark.

Документация:
- README содержит:
  - команды запуска,
  - описание переменных окружения,
  - шаги настройки BotFather,
  - ссылку на production URL.

---

## 13) План реализации (для AI‑Coding агента)

Этап 1. Каркас и интеграция Telegram
- Инициализация WebApp API, тема, expand.
- Роутинг `/` и `/manage`.

Этап 2. Хранилище и модель данных
- CloudStorage adapter + fallback.
- Zod‑валидация схемы + версия.

Этап 3. UI главного экрана
- Список привычек + чекбоксы.
- Нижняя навигация по дням.
- График (SVG) и пересчет данных.

Этап 4. Управление привычками
- CRUD, reorder, архив.
- Валидации и сообщения.

Этап 5. Устойчивость и polish
- Ошибки, skeletons, офлайн‑баннер.
- e2e smoke‑тесты.
- Sentry (опционально).

Этап 6. Бот и деплой
- Бот `/start` + кнопка web_app.
- Production деплой фронта.
- Настройка `/setmenubutton`.

---

## 14) Приложение: тест‑кейсы (минимум)

1. Первый запуск → пусто → добавить привычку → чекбокс отмечается → график показывает 1.
2. Добавить 3 привычки → отметить 2 → график для выбранного дня показывает 2.
3. Переключить день → чекбоксы и график отражают выбранный день.
4. Переключить неделю назад → график и выбранный день корректны.
5. Архивировать привычку → исчезает с главного экрана → график пересчитывается.
6. CloudStorage ошибка (симуляция) → включается fallback → есть баннер.
7. Перезапуск приложения → данные восстановились.

